#!/usr/bin/make -f

export DH_VERBOSE=1
export GO111MODULE=auto
# Allow Go to download modules
export GOPROXY=https://proxy.golang.org,direct 

# Standard debhelper sequence with Go support.
# dpkg-buildpackage will be invoked from the root of the actual
# upstream source tree where the debian/ directory has been copied.
# Thus, all Makefile commands here operate relative to that root.
%:
	dh $@ --with golang

# Override dh_auto_clean to call upstream's clean target but ignore errors.
override_dh_auto_clean:
	@echo "Running overridden dh_auto_clean to clean upstream..."
	-$(MAKE) clean

# Override the build step to use upstream's Makefile.
override_dh_auto_build:
	@echo "Running overridden dh_auto_build to build upstream..."
	# Ensure Go modules are downloaded and tidy before building.
	# These commands are run in the current directory, which is the upstream source root.
	go mod tidy
	go mod download
	$(MAKE) build

# Override dh_auto_test to run tests, show tail of log, and report status
override_dh_auto_test:
	@echo "Running tests via override_dh_auto_test (capturing to test_output.log)..."
	# Run tests, redirecting output. Allow command to fail to capture exit code.
	NO_COLOR=1 $(MAKE) test > test_output.log 2>&1 || true
	TEST_EXIT_CODE=$$?

	@echo "-------------------- Last 100 lines of Test Output (test_output.log) --------------------"
	@tail -n 100 test_output.log || echo "INFO: test_output.log not found or unreadable."
	@echo "---------------------------------- End of Test Output Snippet -----------------------------------"

	# Move the full log for artifact upload before potentially exiting.
	# The filename includes dist and arch for clarity if multiple are built.
	# dpkg-parsechangelog and dpkg-architecture need devscripts to be installed.
	@mv test_output.log $(CURDIR)/../test_output_`dpkg-parsechangelog -S Distribution || echo unknown`_`dpkg-architecture -qDEB_HOST_ARCH || echo unknown`.log || \
		echo "WARNING: Could not move test_output.log for artifact upload."

	if [ $${TEST_EXIT_CODE} -eq 0 ]; then \
	    echo "INFO: Tests completed successfully (exit code 0)."; \
	else \
	    echo "ERROR: Tests failed with exit code $${TEST_EXIT_CODE}. Full log available as an artifact."; \
	    exit $${TEST_EXIT_CODE}; \
	fi

# Override the install step:
# 1. Manually copy the binary built by upstream's Makefile to our staging area.
# 2. Then, let dh_auto_install handle other installations (like config files via .install).
override_dh_auto_install:
	@echo "Running overridden dh_auto_install..."
	# Create the target directory in the package staging area (e.g., debian/fan2go/usr/bin)
	# $(CURDIR) here refers to the root of the source tree where dpkg-buildpackage is running.
	mkdir -p $(CURDIR)/debian/fan2go/usr/bin
	
	# Copy the compiled binary from bin/fan2go (relative to the source tree root)
	# to the staging directory.
	cp $(CURDIR)/bin/fan2go $(CURDIR)/debian/fan2go/usr/bin/fan2go
	
	# Now run the standard dh_auto_install to process debian/*.install files, etc.
	dh_auto_install
